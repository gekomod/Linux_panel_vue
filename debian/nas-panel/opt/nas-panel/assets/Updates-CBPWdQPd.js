import{_ as ue,r as p,q as W,k as de,O as me,e as g,o as n,w as o,a,n as pe,c as y,f as k,b as r,m as I,F as B,g as u,t as c,p as ce,h as d,l as b,I as F,P as fe,Q as ge,G as ve,s as A,z as N}from"./index-DxMqavst.js";const ye={class:"widget-header"},be={class:"header-actions"},we={key:0,class:"warning-message"},Ve={key:0,class:"status-container"},he={class:"progress-container"},ke={class:"status-details"},Fe={class:"status-message"},Ce={class:"status-time"},Ue={key:1,class:"status-pending"},_e={key:0,class:"update-actions"},De={key:0},Se={class:"update-description"},$e={key:0},Te={key:1,class:"update-changelog"},Ee={__name:"Updates",setup(Ie){const w=p([]),j=p(!1),S=p(!1),H=p(""),J=p(""),$=p(!1),V=p(null),D=p(!1),T=p(!1),q=p("daily"),G=p(!0),f=p({}),h=p({}),K=p(!1),L=W.create({baseURL:`${window.location.protocol}//${window.location.hostname}:3000`,timeout:3e4}),O=async()=>{j.value=!0,J.value="";try{const e=await L.get("/system/updates/check");w.value=e.data.updates,H.value=new Date().toLocaleString(),w.value.length===0&&A.success("System is up to date")}catch(e){J.value="Failed to check updates: "+(e.response?.data?.message||e.message),console.error("Update check error:",e)}finally{j.value=!1}},X=async()=>{try{await N.confirm(`This will install ${w.value.length} updates. Continue?`,"Confirm Updates",{confirmButtonText:"Install",cancelButtonText:"Cancel",type:"warning"}),S.value=!0;const e=w.value.map(m=>m.name);w.value.forEach(m=>{Q(m.name)});const l=await L.post("/system/updates/install",{packages:e,no_confirm:!0}),s=new EventSource(`${window.location.protocol}//${window.location.hostname}:3000/system/updates/progress/_all`);h.value._all=s,s.onmessage=m=>{const i=JSON.parse(m.data);w.value.forEach(C=>{U(C.name,{progress:i.progress,status:i.status||"",message:i.message||"Installing...",indeterminate:i.progress<30})}),i.progress===100&&setTimeout(()=>{s.close(),delete h.value._all,O()},1500)},s.onerror=m=>{console.error("SSE Error:",m),w.value.forEach(i=>{U(i.name,{progress:0,status:"exception",message:"Connection error"})}),s.close(),delete h.value._all}}catch(e){e!=="cancel"&&A.error("Installation failed: "+(e.response?.data?.message||e.message))}finally{S.value=!1}},Y=async e=>{try{await N.confirm(`Install ${e.name} (${e.new_version})?`,"Confirm Update",{confirmButtonText:"Install",cancelButtonText:"Cancel",type:"info"}),Q(e.name);const l=await L.post("/system/updates/install",{packages:[e.name],no_confirm:!0}),s=new EventSource(`${window.location.protocol}//${window.location.hostname}:3000/system/updates/progress/${e.name}`);h.value[e.name]=s,s.onmessage=m=>{try{const i=JSON.parse(m.data);U(e.name,{progress:i.progress,status:i.status||"",message:i.message||"Installing...",indeterminate:i.progress<30}),i.progress===100&&setTimeout(()=>{s.close(),delete h.value[e.name],O()},1500)}catch(i){console.error("Error parsing SSE data:",i)}},s.onerror=m=>{console.error("SSE Error:",m),U(e.name,{progress:0,status:"exception",message:"Connection error"}),s.close(),delete h.value[e.name]}}catch(l){l!=="cancel"&&U(e.name,{progress:0,status:"exception",message:l.response?.data?.message||l.message})}},Q=e=>{f.value[e]={progress:0,status:"",message:"Starting installation...",time:new Date().toLocaleTimeString(),indeterminate:!0}},U=(e,l)=>{f.value[e]={...f.value[e]||{},...l,time:new Date().toLocaleTimeString(),indeterminate:l.progress===0&&l.message.includes("Downloading")}},Z=async e=>{try{await N.confirm(`Cancel installation of ${e}?`,"Confirm Cancellation",{type:"warning"}),await W.delete(`/system/updates/cancel/${e}`),h.value[e]&&(h.value[e].close(),delete h.value[e]),U(e,{progress:0,status:"exception",message:"Installation cancelled"})}catch(l){l!=="cancel"&&A.error(`Failed to cancel: ${l.message}`)}},x=e=>{V.value=e,$.value=!0},ee=()=>{D.value=!0},le=()=>{A.success("Automatic updates settings saved!"),D.value=!1};return de(()=>{O()}),me(()=>{Object.values(h.value).forEach(e=>e.close())}),(e,l)=>{const s=r("el-button"),m=r("el-tooltip"),i=r("el-option"),C=r("el-select"),v=r("el-form-item"),z=r("el-input"),M=r("el-form"),E=r("el-dialog"),P=r("el-switch"),te=r("el-alert"),_=r("el-table-column"),ae=r("el-progress"),oe=r("el-table"),R=r("el-icon"),se=r("el-divider"),ne=r("el-card"),ie=ce("loading");return n(),g(ne,{class:"filesystems-widget"},{header:o(()=>[d("div",ye,[a(b(F),{icon:"mdi:file-tree",width:"20",height:"20"}),d("span",null,c(e.t("storageFilesystems.title")),1),d("div",be,[a(m,{content:e.t("storageFilesystems.mount")},{default:o(()=>[a(s,{size:"small",onClick:e.showMountDialog,disabled:e.loading,text:""},{default:o(()=>[a(b(F),{icon:"mdi:usb-flash-drive",width:"16",height:"16"})]),_:1},8,["onClick","disabled"])]),_:1},8,["content"]),a(m,{content:e.t("storageFilesystems.format")},{default:o(()=>[a(s,{size:"small",onClick:e.showFormatDialog,disabled:e.loading,text:""},{default:o(()=>[a(b(F),{icon:"mdi:format-list-checks",width:"16",height:"16"})]),_:1},8,["onClick","disabled"])]),_:1},8,["content"]),a(m,{content:e.t("storageFilesystems.refresh")},{default:o(()=>[a(s,{size:"small",onClick:e.refreshFilesystems,loading:e.loading,text:""},{default:o(()=>[a(b(F),{icon:"mdi:refresh",width:"16",height:"16",class:ve({spin:e.loading})},null,8,["class"])]),_:1},8,["onClick","loading"])]),_:1},8,["content"])])])]),default:o(()=>[a(E,{modelValue:e.mountDialogVisible,"onUpdate:modelValue":l[5]||(l[5]=t=>e.mountDialogVisible=t),title:e.t("storageFilesystems.mountDialog.title"),width:"500px"},{footer:o(()=>[a(s,{onClick:l[4]||(l[4]=t=>e.mountDialogVisible=!1)},{default:o(()=>[u(c(e.t("common.cancel")),1)]),_:1}),a(s,{type:"primary",onClick:e.mountDevice,loading:e.mountLoading},{default:o(()=>[u(c(e.t("storageFilesystems.mountDialog.mount")),1)]),_:1},8,["onClick","loading"])]),default:o(()=>[a(M,{model:e.mountForm,"label-position":"top"},{default:o(()=>[a(v,{label:e.t("storageFilesystems.mountDialog.device")},{default:o(()=>[a(C,{modelValue:e.mountForm.device,"onUpdate:modelValue":l[0]||(l[0]=t=>e.mountForm.device=t),placeholder:"Select device",style:{width:"100%"}},{default:o(()=>[(n(!0),y(B,null,I(e.unmountedDevices,t=>(n(),g(i,{key:t.path,label:`${t.path} (${t.model||"Unknown"})`,value:t.path},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1},8,["label"]),a(v,{label:e.t("storageFilesystems.mountDialog.mountPoint")},{default:o(()=>[a(z,{modelValue:e.mountForm.mountPoint,"onUpdate:modelValue":l[1]||(l[1]=t=>e.mountForm.mountPoint=t),placeholder:"/mnt/new_disk"},null,8,["modelValue"])]),_:1},8,["label"]),a(v,{label:e.t("storageFilesystems.mountDialog.fsType")},{default:o(()=>[a(C,{modelValue:e.mountForm.fsType,"onUpdate:modelValue":l[2]||(l[2]=t=>e.mountForm.fsType=t),placeholder:"Select filesystem type",style:{width:"100%"}},{default:o(()=>[(n(!0),y(B,null,I(e.supportedFilesystems,t=>(n(),g(i,{key:t,label:t,value:t},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1},8,["label"]),a(v,{label:e.t("storageFilesystems.mountDialog.options")},{default:o(()=>[a(z,{modelValue:e.mountForm.options,"onUpdate:modelValue":l[3]||(l[3]=t=>e.mountForm.options=t),placeholder:"defaults,nofail"},null,8,["modelValue"])]),_:1},8,["label"])]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),a(E,{modelValue:e.formatDialogVisible,"onUpdate:modelValue":l[11]||(l[11]=t=>e.formatDialogVisible=t),title:e.t("storageFilesystems.formatDialog.title"),width:"500px"},{footer:o(()=>[a(s,{onClick:l[10]||(l[10]=t=>e.formatDialogVisible=!1)},{default:o(()=>[u(c(e.t("common.cancel")),1)]),_:1}),a(s,{type:"danger",onClick:e.formatDevice,loading:e.formatLoading},{default:o(()=>[u(c(e.t("storageFilesystems.formatDialog.format")),1)]),_:1},8,["onClick","loading"])]),default:o(()=>[a(M,{model:e.formatForm,"label-position":"top"},{default:o(()=>[a(v,{label:e.t("storageFilesystems.formatDialog.device")},{default:o(()=>[a(C,{modelValue:e.formatForm.device,"onUpdate:modelValue":l[6]||(l[6]=t=>e.formatForm.device=t),placeholder:"Select device",style:{width:"100%"}},{default:o(()=>[(n(!0),y(B,null,I(e.formatableDevices,t=>(n(),g(i,{key:t.path,label:`${t.path} (${t.model||"Unknown"})`,value:t.path},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1},8,["label"]),a(v,{label:e.t("storageFilesystems.formatDialog.fsType")},{default:o(()=>[a(C,{modelValue:e.formatForm.fsType,"onUpdate:modelValue":l[7]||(l[7]=t=>e.formatForm.fsType=t),placeholder:"Select filesystem type",style:{width:"100%"}},{default:o(()=>[(n(!0),y(B,null,I(e.supportedFilesystems,t=>(n(),g(i,{key:t,label:t,value:t},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1},8,["label"]),e.formatForm.fsType?(n(),g(v,{key:0,label:e.t("storageFilesystems.formatDialog.label")},{default:o(()=>[a(z,{modelValue:e.formatForm.label,"onUpdate:modelValue":l[8]||(l[8]=t=>e.formatForm.label=t),placeholder:`${e.formatForm.fsType}_VOLUME`},null,8,["modelValue","placeholder"])]),_:1},8,["label"])):k("",!0),a(v,{label:e.t("storageFilesystems.formatDialog.force")},{default:o(()=>[a(P,{modelValue:e.formatForm.force,"onUpdate:modelValue":l[9]||(l[9]=t=>e.formatForm.force=t)},null,8,["modelValue"])]),_:1},8,["label"])]),_:1},8,["model"]),e.formatForm.device?(n(),y("div",we,[a(te,{type:"warning",closable:!1},{default:o(()=>[u(c(e.t("storageFilesystems.formatDialog.warning",{device:e.formatForm.device})),1)]),_:1})])):k("",!0)]),_:1},8,["modelValue","title"]),pe((n(),g(oe,{data:e.filesystems,style:{width:"100%"}},{default:o(()=>[a(_,{prop:"name",label:"Package",width:"180"}),a(_,{prop:"current_version",label:"Current Version"}),a(_,{prop:"new_version",label:"New Version"}),a(_,{prop:"description",label:"Description","show-overflow-tooltip":""}),a(_,{label:"Actions",width:"120"},{default:o(({row:t})=>[a(s,{size:"small",type:"primary",plain:"",onClick:re=>x(t)},{default:o(()=>l[20]||(l[20]=[u(" Details ")])),_:2,__:[20]},1032,["onClick"])]),_:1}),a(_,{label:"Status",width:"220"},{default:o(({row:t})=>[K.value||f.value[t.name]?(n(),y("div",Ve,[d("div",he,[a(ae,{percentage:f.value[t.name].progress,status:f.value[t.name].status,"text-inside":!0,"stroke-width":18,indeterminate:f.value[t.name].indeterminate,class:"progress-bar"},null,8,["percentage","status","indeterminate"]),f.value[t.name].progress<100?(n(),g(s,{key:0,size:"small",type:"danger",plain:"",circle:"",onClick:re=>Z(t.name),class:"cancel-btn"},{default:o(()=>[a(b(F),{icon:"mdi:close",width:"16"})]),_:2},1032,["onClick"])):k("",!0)]),d("div",ke,[d("span",Fe,[f.value[t.name].status==="success"?(n(),g(b(F),{key:0,icon:"mdi:check-circle",width:"14",class:"status-icon"})):f.value[t.name].status==="exception"?(n(),g(b(F),{key:1,icon:"mdi:alert-circle",width:"14",class:"status-icon"})):(n(),g(b(F),{key:2,icon:"mdi:progress-clock",width:"14",class:"status-icon"})),u(" "+c(f.value[t.name].message),1)]),d("span",Ce,c(f.value[t.name].time),1)])])):(n(),y("span",Ue,[a(b(F),{icon:"mdi:clock-outline",width:"14",class:"status-icon"}),l[21]||(l[21]=u(" Pending "))]))]),_:1})]),_:1},8,["data"])),[[ie,e.loading]]),w.value.length>0?(n(),y("div",_e,[a(s,{type:"primary",onClick:X,loading:S.value,disabled:w.value.length===0||Object.values(f.value).some(t=>t.progress>0&&t.progress<100)},{default:o(()=>[a(R,{class:"el-icon--left"},{default:o(()=>[a(b(fe))]),_:1}),u(" "+c(S.value?"Installing...":`Install All (${w.value.length})`),1)]),_:1},8,["loading","disabled"]),a(s,{type:"danger",onClick:ee},{default:o(()=>[a(R,{class:"el-icon--left"},{default:o(()=>[a(b(ge))]),_:1}),l[22]||(l[22]=u(" Automatic Updates "))]),_:1,__:[22]})])):k("",!0),a(E,{modelValue:$.value,"onUpdate:modelValue":l[14]||(l[14]=t=>$.value=t),title:"Update Details",width:"50%"},{footer:o(()=>[a(s,{onClick:l[12]||(l[12]=t=>$.value=!1)},{default:o(()=>l[27]||(l[27]=[u("Close")])),_:1,__:[27]}),a(s,{type:"primary",onClick:l[13]||(l[13]=t=>Y(V.value))},{default:o(()=>l[28]||(l[28]=[u(" Install This Update ")])),_:1,__:[28]})]),default:o(()=>[V.value?(n(),y("div",De,[d("h4",null,c(V.value.name),1),a(se),d("p",null,[l[23]||(l[23]=d("strong",null,"Current Version:",-1)),u(" "+c(V.value.current_version),1)]),d("p",null,[l[24]||(l[24]=d("strong",null,"New Version:",-1)),u(" "+c(V.value.new_version),1)]),l[26]||(l[26]=d("p",null,[d("strong",null,"Description:")],-1)),d("pre",Se,c(V.value.description),1),V.value.changelog?(n(),y("p",$e,l[25]||(l[25]=[d("strong",null,"Changelog:",-1)]))):k("",!0),V.value.changelog?(n(),y("pre",Te,c(V.value.changelog),1)):k("",!0)])):k("",!0)]),_:1},8,["modelValue"]),a(E,{modelValue:D.value,"onUpdate:modelValue":l[19]||(l[19]=t=>D.value=t),title:"Automatic Updates Settings",width:"40%"},{footer:o(()=>[a(s,{onClick:l[18]||(l[18]=t=>D.value=!1)},{default:o(()=>l[29]||(l[29]=[u("Cancel")])),_:1,__:[29]}),a(s,{type:"primary",onClick:le},{default:o(()=>l[30]||(l[30]=[u("Save")])),_:1,__:[30]})]),default:o(()=>[a(M,{"label-position":"top"},{default:o(()=>[a(v,{label:"Enable Automatic Updates"},{default:o(()=>[a(P,{modelValue:T.value,"onUpdate:modelValue":l[15]||(l[15]=t=>T.value=t)},null,8,["modelValue"])]),_:1}),T.value?(n(),g(v,{key:0,label:"Update Schedule"},{default:o(()=>[a(C,{modelValue:q.value,"onUpdate:modelValue":l[16]||(l[16]=t=>q.value=t),placeholder:"Select schedule"},{default:o(()=>[a(i,{label:"Daily",value:"daily"}),a(i,{label:"Weekly",value:"weekly"}),a(i,{label:"Monthly",value:"monthly"})]),_:1},8,["modelValue"])]),_:1})):k("",!0),T.value?(n(),g(v,{key:1,label:"Security Updates Only"},{default:o(()=>[a(P,{modelValue:G.value,"onUpdate:modelValue":l[17]||(l[17]=t=>G.value=t)},null,8,["modelValue"])]),_:1})):k("",!0)]),_:1})]),_:1},8,["modelValue"])]),_:1})}}},Ae=ue(Ee,[["__scopeId","data-v-9539d22c"]]);export{Ae as default};
